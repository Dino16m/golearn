<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title class="text-capitalize">{{ .appName}} password reset</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.css" rel="stylesheet" />
</head>

<body>
    <header>
        <style>
            #intro {
                height: 100vh;
            }

            body{
                background-image: url(https://mdbootstrap.com/img/new/fluid/city/008.jpg);
            }
            /* Height for devices larger than 576px */
            @media (min-width: 992px) {
                
            }
            .navbar .nav-link {
                color: #fff !important;
            }
        </style>
        
    </header>

    <!-- Background image -->
    <div id="intro" class="bg-image shadow-2-strong">
        <div class="mask d-flex align-items-center h-100" style="background-color: rgba(0, 0, 0, 0.8);">
            
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-xl-5 col-md-8">
                        <h2 class="my-2 text-light text-center">Set a new password for {{ .appName}}</h2>
                        <form class="bg-white rounded shadow-5-strong p-5" id="form">
                            <!-- password input -->
                            <div class="form-outline mb-4">
                                <input type="password" name="password" required id="password" class="form-control" />
                                <label class="form-label" for="password">Password</label>
                            </div>

                            <!-- confirmation input -->
                            <div class="form-outline mb-4">
                                <input type="password"  name="confirm-password" required id="form1Example2" class="form-control" />
                                <label class="form-label" for="form1Example2">Confirm password</label>
                                <div class="invalid-feedback">Passwords don't match.</div>
                            </div>

                            <input type="hidden" name="code" value="{{ .code }}">
                            <input type="hidden" name="signature" value="{{.signature}}">
                            <!-- Submit button -->
                            <button type="submit" class="btn btn-primary btn-block">Reset</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <!-- Background image -->

    <!-- Button trigger modal -->
<button type="button"  class="d-none btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#exampleModal">
    Launch demo modal
  </button>
  
  <!-- Modal -->
  <div class="modal right " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-mdb-backdrop="true" data-mdb-keyboard="true">
    <div class="modal-dialog modal-side modal-top-right ">
      <div class="modal-content ">
        <div class="modal-header bg-success">
          <h5 class="modal-title" id="modalLabel">Error</h5>
          <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">something went very wrong</div>
      </div>
    </div>
  </div>

  <!--Spinner-->
    <div class="d-none">
    <div class="spinner-border spinner text-warning" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>

    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.js"></script>
    <script>
        const modalTrigger = document.querySelector('button[data-mdb-toggle="modal"]')
        const form = document.querySelector("#form")
        const submitBtn = document.querySelector('button[type="submit"]')
        form.addEventListener("submit", async (event) => {
            event.preventDefault()
            const password = form.elements["password"].value
            const confirm = form.elements["confirm-password"].value
            const code = form.elements["code"].value
            const signature = form.elements["signature"].value
            if (!validate(form.elements["confirm-password"], password, confirm))
                return
            setLoading(submitBtn)
            await submit(password, code, signature)
            unsetLoading(submitBtn)
        })

        function validate(elem, password, confirm){
            if(password != confirm){
                elem.classList.add('is-invalid')
                setTimeout(() => elem.classList.remove('is-invalid'), 10000)
            }
            return password == confirm
        }
        
        async function submit(password, code, signature){
            const data = {
                password: password,
                code: parseInt(code), 
                signature: signature
            }
            const response = await fetch("/reset-password", {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            const resData = await response.json()
            if (resData.status){
                popup("Success", "Password has been reset. You are being redirected", true)
                window.location.replace("/")
            }else{
                popup("Error", resData.error, false)
            }
        }

        function popup(title, message, ok){
            const header = document.querySelector(".modal-header")
            const label = document.querySelector("#modalLabel")
            const body = document.querySelector('.modal-body')

            title.innerHTML = label
            body.innerHTML = message
            modalTrigger.click()

            if (ok){
                header.classList.add("bg-success")
            }else{
                header.classList.add("bg-danger")
            }
            setTimeout(() => {
                title.innerHTML = ""
                body.innerHTML = ""
                header.classList.remove("bg-danger", "bg-success")
                modalTrigger.click()
            }, 10000)
        }

        function setLoading(btn){
            btn.setAttribute("disabled", true)
            const spinner =  document.querySelector(".spinner")
            btn.innerHTML = ""
            btn.appendChild(spinner)
        }
        function unsetLoading(btn){
            btn.setAttribute("disabled", false)
            btn.innerHTML = "Reset"
        }
    </script>
</body>

</html>